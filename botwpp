console.log("ðŸ”¥ Bot estÃ¡ iniciando...");

const client = new Client({
  puppeteer: {
    args: [
      '--no-sandbox',
      '--disable-setuid-sandbox',
      '--disable-dev-shm-usage'
    ]
  },
  restartOnAuthFail: true,
  takeoverOnConflict: true
});
console.log("ðŸŸ¢ Bot iniciando..."); // Mensagem de teste
console.log("VersÃ£o do Node:", process.version); // Verifica se o Node.js estÃ¡ correto
const qrcode = require('qrcode-terminal');
const { Client } = require('whatsapp-web.js');
const ExcelJS = require('exceljs');
const fs = require('fs').promises;
const path = require('path');

// 1. CONFIGURAÃ‡ÃƒO INICIAL
const client = new Client();
const dataDir = path.join(__dirname, 'data');
const filePath = path.join(dataDir, 'leads.xlsx');
const backupPath = path.join(dataDir, 'leads_backup.json');

// 2. INICIALIZAÃ‡ÃƒO DA PASTA
async function init() {
    try {
        await fs.mkdir(dataDir, { recursive: true });
        console.log(`ðŸ“‚ Pasta data criada em: ${dataDir}`);
        
        try {
            await fs.access(dataDir, fs.constants.W_OK);
        } catch {
            throw new Error('Sem permissÃ£o de escrita na pasta');
        }
    } catch (err) {
        console.error('âŒ Erro na inicializaÃ§Ã£o:', err);
        throw err;
    }
}

// 3. FUNÃ‡ÃƒO DE SALVAMENTO CORRIGIDA
async function salvarLead(nome, telefone, email, fonte, interesse) {
    const leadData = {
        nome,
        telefone: telefone.replace('@c.us', ''),
        email,
        fonte,
        interesse,
        data: new Date().toLocaleString('pt-BR')
    };

    const workbook = new ExcelJS.Workbook();
    let worksheet;

    try {
        // Verifica se o arquivo existe
        try {
            await workbook.xlsx.readFile(filePath);
            worksheet = workbook.getWorksheet('Leads') || workbook.addWorksheet('Leads');
            console.log('âœ” Planilha existente carregada');
        } catch (error) {
            console.log('ðŸ†• Criando nova planilha...');
            worksheet = workbook.addWorksheet('Leads');
            worksheet.columns = [
                { header: 'Nome', key: 'nome', width: 20 },
                { header: 'Telefone', key: 'telefone', width: 15 },
                { header: 'E-mail', key: 'email', width: 25 },
                { header: 'Como Chegou', key: 'fonte', width: 20 },
                { header: 'Interesse', key: 'interesse', width: 30 },
                { header: 'Data/Hora', key: 'data', width: 25 }
            ];
        }

        // Adiciona os dados
        worksheet.addRow(leadData);

        // SALVAMENTO CORRIGIDO (usando writeFile diretamente)
        await workbook.xlsx.writeFile(filePath);
        console.log('âœ… Lead salvo com sucesso no Excel!');
        return true;

    } catch (err) {
        console.error('âŒ Erro ao salvar no Excel:', err);
        
        // Tenta fazer backup
        try {
            await salvarBackup(leadData);
            console.log('ðŸ“¦ Backup JSON criado como fallback');
            return false;
        } catch (backupErr) {
            console.error('âŒ Falha no backup:', backupErr);
            return false;
        }
    }
}

// 4. BACKUP EM JSON (mantido igual)
async function salvarBackup(data) {
    try {
        let backups = [];
        try {
            const content = await fs.readFile(backupPath, 'utf8');
            backups = JSON.parse(content);
        } catch {}

        backups.push(data);
        await fs.writeFile(backupPath, JSON.stringify(backups, null, 2));
        return true;
    } catch (err) {
        throw err;
    }
}

// 5. FLUXO DE MENSAGENS (mantido igual)
const conversas = {};

client.on('qr', qr => {
    qrcode.generate(qr, { small: true });
});

client.on('ready', async () => {
    console.log('ðŸš€ Bot conectado!');
    try {
        await init();
        console.log(`ðŸ“Š Dados serÃ£o salvos em: ${filePath}`);
        
        const testeSalvo = await salvarLead(
            'Teste', '5511999999999', 
            'teste@teste.com', 'Teste', 'Teste'
        );
        
        if (!testeSalvo) {
            console.error('âš ï¸ AVISO: Problema no salvamento inicial');
        }
    } catch (err) {
        console.error('âŒ Falha na inicializaÃ§Ã£o:', err);
    }
});

client.on('message', async msg => {
    if (msg.from.endsWith('@c.us')) {
        try {
            const telefone = msg.from;
            const chat = await msg.getChat();

            if (msg.body.toLowerCase().trim() === 'atendente') {
                await client.sendMessage(telefone, 'Um atendente serÃ¡ contactado em breve!');
                return;
            }

            if (!conversas[telefone] || /in[Ã­i]cio|menu|oi|olÃ¡/i.test(msg.body)) {
                conversas[telefone] = { etapa: 1 };
                await client.sendMessage(telefone, 
                    'OlÃ¡, tudo bem? ðŸ˜„ Sou o assistente virtual da Master Project. Qual seu nome, por favor?'
                );
                return;
            }

            if (conversas[telefone].etapa === 1) {
                conversas[telefone] = { ...conversas[telefone], nome: msg.body, etapa: 2 };
                await client.sendMessage(telefone, 
                    `Obrigado, ${msg.body.split(' ')[0]}! Qual seu e-mail para contato?`
                );
                return;
            }

            if (conversas[telefone].etapa === 2) {
                if (!msg.body.includes('@') || !msg.body.includes('.')) {
                    await client.sendMessage(telefone, 'Por favor, digite um e-mail vÃ¡lido (exemplo: nome@provedor.com)');
                    return;
                }
                conversas[telefone] = { ...conversas[telefone], email: msg.body, etapa: 3 };
                await client.sendMessage(telefone, 
                    'Como vocÃª chegou atÃ© nÃ³s? (Exemplo: Facebook, Instagram, indicaÃ§Ã£o, etc.)'
                );
                return;
            }

            if (conversas[telefone].etapa === 3) {
                conversas[telefone] = { ...conversas[telefone], fonte: msg.body, etapa: 4 };
                await client.sendMessage(telefone, 
                    'Nosso horÃ¡rio de atendimento Ã© de segunda a sexta-feira, das 09h Ã s 18h. ' +
                    'Caso tenha nos contatado fora do horÃ¡rio, responderemos no prÃ³ximo dia Ãºtil. ðŸ˜Š'
                );
                await new Promise(resolve => setTimeout(resolve, 2000));
                await client.sendMessage(telefone,
                    `Gostaria de saber qual treinamento vocÃª tem mais interesse, ` +
                    `${conversas[telefone].nome.split(' ')[0]}. Por favor, escolha uma opÃ§Ã£o:\n\n` +
                    '1ï¸âƒ£ GestÃ£o de Projetos HÃ­brida\n' +
                    '2ï¸âƒ£ Excel AvanÃ§ado\n' +
                    '3ï¸âƒ£ Power BI\n' +
                    '4ï¸âƒ£ Trilha Master (todos os 3 cursos)'
                );
                return;
            }

            if (conversas[telefone].etapa === 4) {
                let curso, link;
                if (/1|gestÃ£o|projeto|hÃ­brida/i.test(msg.body)) {
                    curso = 'GestÃ£o de Projetos HÃ­brida';
                    link = 'https://www.masterproject.com.br/gestao';
                } else if (/2|excel/i.test(msg.body)) {
                    curso = 'Excel AvanÃ§ado';
                    link = 'https://www.masterproject.com.br/excel';
                } else if (/3|power\s*bi/i.test(msg.body)) {
                    curso = 'Power BI';
                    link = 'https://www.masterproject.com.br/powerbi';
                } else if (/4|todos|trilha/i.test(msg.body)) {
                    curso = 'Trilha Master';
                    link = 'https://www.masterproject.com.br/trilha';
                } else {
                    await client.sendMessage(telefone, 
                        'OpÃ§Ã£o invÃ¡lida. Por favor, digite:\n\n' +
                        '1ï¸âƒ£ GestÃ£o de Projetos\n' +
                        '2ï¸âƒ£ Excel\n' +
                        '3ï¸âƒ£ Power BI\n' +
                        '4ï¸âƒ£ Trilha Completa\n\n' +
                        'Ou "atendente" para ajuda humana'
                    );
                    return;
                }

                const salvou = await salvarLead(
                    conversas[telefone].nome,
                    telefone,
                    conversas[telefone].email,
                    conversas[telefone].fonte,
                    curso
                );

                if (salvou) {
                    await client.sendMessage(telefone, `Aqui estÃ¡ o link: ${link}`);
                }
                await client.sendMessage(telefone,
                    'Agradecemos pelo seu interesse! ðŸ˜Š\n\n' +
                    'Digite "inÃ­cio" para recomeÃ§ar ou "atendente" para ajuda.'
                );
            }

        } catch (err) {
            console.error('âŒ Erro no processamento:', err);
        }
    }
});

// 6. INICIALIZAÃ‡ÃƒO
client.on('loading_screen', (percent, message) => {
  console.log(`ðŸ”„ Carregando: ${percent}% - ${message}`);
client.initialize();

// 7. TRATAMENTO DE ERROS
process.on('unhandledRejection', err => {
    console.error('âŒ Erro nÃ£o tratado:', err);
});
// MantÃ©m o Render ativo (adicione ANTES do client.initialize())
const http = require('http');
const server = http.createServer((req, res) => {
  res.writeHead(200);
  res.end('Bot online!');
});
server.listen(process.env.PORT || 3000);
